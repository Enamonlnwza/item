<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Operations</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="order-bg">
        <div class="order-container admin-container">
            <h2 class="admin-title">แผงจัดการ (ยกเลิก / แก้ไข)</h2>

            <label for="selectCustomer">เลือกชื่อลูกค้าที่ต้องการจัดการ</label>
            <select id="selectCustomer" class="admin-input"></select>

            <div id="ordersList" style="margin-top:18px"></div>

            <div style="display:flex; gap:12px; margin-top:18px;">
                <button id="cancelBtn" class="admin-btn" type="button">ยกเลิกรายการที่เลือก</button>
                <button id="toggleEditBtn" class="admin-btn" type="button">เข้าสู่โหมดแก้ไข</button>
            </div>

            <div id="opsMsg" class="admin-msg"></div>

            <button type="button" class="admin-btn back-btn" onclick="window.location.href='admin.html'">กลับไปหน้าเพิ่มสินค้า</button>
            <button type="button" class="admin-btn back-btn" onclick="window.location.href='index.html'">กลับไปหน้าแรก</button>
        </div>
    </div>

    <script>
        // Load customers from localStorage and populate select
        function loadCustomers() {
            const orders = JSON.parse(localStorage.getItem('orders') || '{}');
            const select = document.getElementById('selectCustomer');
            select.innerHTML = '';
            const keys = Object.keys(orders);
            if (keys.length === 0) {
                const opt = document.createElement('option');
                opt.textContent = 'ไม่มีข้อมูลลูกค้า';
                opt.value = '';
                select.appendChild(opt);
                renderOrders([]);
                return;
            }
            keys.forEach(k => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k;
                select.appendChild(opt);
            });
            renderOrders(orders[select.value] || []);
        }

        function renderOrders(list) {
            const container = document.getElementById('ordersList');
            container.innerHTML = '';
            if (!list || list.length === 0) {
                container.textContent = 'ไม่มีรายการสำหรับลูกค้าคนนี้';
                return;
            }
            list.forEach((o, idx) => {
                const el = document.createElement('div');
                el.className = 'order-item';
                el.innerHTML = `
                    <img src="${o.img || 'https://via.placeholder.com/100'}" alt="img">
                    <div class="order-detail">
                        <div class="order-title">${o.name}</div>
                        <a class="order-link" href="${o.link}" target="_blank">ลิ้งค์สินค้า</a>
                    </div>
                    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                        <input type="radio" name="selectedOrder" value="${idx}" aria-label="เลือกรายการ">
                        <button class="admin-btn small edit-btn" data-idx="${idx}" style="display:none;">แก้ไข</button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        document.getElementById('selectCustomer').addEventListener('change', function() {
            const orders = JSON.parse(localStorage.getItem('orders') || '{}');
            renderOrders(orders[this.value] || []);
        });

        document.getElementById('cancelBtn').addEventListener('click', function() {
            const select = document.getElementById('selectCustomer');
            const customer = select.value;
            if (!customer) return alert('กรุณาเลือกชื่อลูกค้าก่อน');
            const radios = document.getElementsByName('selectedOrder');
            let chosen = -1;
            for (const r of radios) if (r.checked) chosen = parseInt(r.value, 10);
            if (chosen === -1) return alert('กรุณาเลือกหนึ่งรายการเพื่อยกเลิก');
            let orders = JSON.parse(localStorage.getItem('orders') || '{}');
            if (!orders[customer] || !orders[customer][chosen]) return alert('ไม่พบรายการ');
            // remove selected
            orders[customer].splice(chosen, 1);
            if (orders[customer].length === 0) delete orders[customer];
            localStorage.setItem('orders', JSON.stringify(orders));
            document.getElementById('opsMsg').textContent = 'ยกเลิกรายการเรียบร้อย';
            loadCustomers();
            setTimeout(() => document.getElementById('opsMsg').textContent = '', 2000);
        });

        // Toggle edit mode: show tiny edit buttons (client-side only)
        let editMode = false;
        document.getElementById('toggleEditBtn').addEventListener('click', function() {
            const container = document.getElementById('ordersList');
            editMode = !editMode;
            this.textContent = editMode ? 'ออกจากโหมดแก้ไข' : 'เข้าสู่โหมดแก้ไข';
            // toggle display of edit buttons
            const btns = container.querySelectorAll('.edit-btn');
            if (btns.length === 0) {
                // re-render to ensure buttons exist
                const select = document.getElementById('selectCustomer');
                const orders = JSON.parse(localStorage.getItem('orders') || '{}');
                renderOrders(orders[select.value] || []);
            }
            container.querySelectorAll('.edit-btn').forEach(b => {
                b.style.display = editMode ? 'inline-block' : 'none';
            });
            // attach edit handlers when enabling
            if (editMode) {
                container.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const idx = parseInt(this.getAttribute('data-idx'), 10);
                        const select = document.getElementById('selectCustomer');
                        const customer = select.value;
                        let orders = JSON.parse(localStorage.getItem('orders') || '{}');
                        const item = orders[customer][idx];
                        const newName = prompt('แก้ไขชื่อสินค้า:', item.name);
                        if (newName === null) return;
                        item.name = newName;
                        orders[customer][idx] = item;
                        localStorage.setItem('orders', JSON.stringify(orders));
                        renderOrders(orders[customer] || []);
                        document.getElementById('opsMsg').textContent = 'บันทึกการแก้ไขแล้ว';
                        setTimeout(() => document.getElementById('opsMsg').textContent = '', 2000);
                    });
                });
            }
        });

        // initial load
        loadCustomers();
    </script>
</body>
</html>
